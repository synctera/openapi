#!/usr/bin/env bash

set -e
set -o pipefail

start_dir=$(pwd)
spec_dir=$(mktemp --directory --suffix .spec)

set -x

cd "${start_dir}/cmd/gather_openapi_specs"

sc git cp openapi "common/*.yml" common/
sc git cp openapi "common/paths/*.yml" common/paths/

go run . --output "${spec_dir}" \
	--skip wipe \
	--skip quickstart \
	--project "mainapi:${MAINAPI_OPENAPI_BRANCH}" \
	--project "banner:${BANNER_OPENAPI_BRANCH}" \
	--project "webhook:${WEBHOOK_OPENAPI_BRANCH}" \
	--external webhooks \
	--project "egress-gateway:${EGRESS_GATEWAY_OPENAPI_BRANCH}" \
	--project "cards:${CARDS_OPENAPI_BRANCH}" \
	--external cards \
	--external transaction_simulations \
	--external webhook_simulations \
	--project "waitlist:${WAITLIST_OPENAPI_BRANCH}" \
	--project "trisk:${TRISK_OPENAPI_BRANCH}" \
	--project "achilles:${ACHILLES_OPENAPI_BRANCH}" \
	--external ach \
	--external ach_transaction_simulations \
	--project "payola:${PAYOLA_OPENAPI_BRANCH}" \
	--external spend_controls \
	--external transactions \
	--project "checkmate:${CHECKMATE_OPENAPI_BRANCH}" \
	--external rdc \
	--project "stately:${STATELY_OPENAPI_BRANCH}" \
	--external statements \
	--project "cronut:${CRONUT_OPENAPI_BRANCH}" \
	--project "payback:${PAYBACK_OPENAPI_BRANCH}" \
	--project "cashier:${CASHIER_OPENAPI_BRANCH}" \
	--external cash_pickups \
	--project "haywire:${HAYWIRE_OPENAPI_BRANCH}" \
	--external wires \
	--project "quickstart:${QUICKSTART_OPENAPI_BRANCH}" \
	--external workspaces \
	--project "docstore:${DOCSTORE_OPENAPI_BRANCH}" \
	--external documents

cd "${spec_dir}"
versions=($(ls))
echo "versions found: ${versions[@]}"
for v in ${versions[@]}; do
	echo "running for version ${v}"
	cur_spec_dir="${spec_dir}/${v}"
	cd "${cur_spec_dir}"

	echo "calling merge cli to merge external spec"
	cat merge-external-apis.json
	openapi-merge-cli --config merge-external-apis.json

	echo "filtering for the external"
	cd "${start_dir}/cmd/externalfilter"
	go run . -v "${cur_spec_dir}/external-api-merged-bundled.yml"

	cd "${cur_spec_dir}"

	# override each spec with header.yml to ensure they all match openapi version, our version and our servers
	for spec in *-api-bundled.yml; do
	  for field in openapi info servers; do
	    yq eval-all "select(fileIndex==0).${field} = select(fileIndex==1).${field} | select(fileIndex==0)" "${spec}" "${start_dir}/header.yml" > ".tmp.${spec}"
	    mv ".tmp.${spec}" "${spec}"
	  done
	done

	for spec in **/api.yml *-api-merged-bundled.yml; do
	  swagger-cli validate "$spec"
	  openapi lint "$spec"
	done

	echo "Copying the generated file for archiving"
	cp ./external-api-merged-bundled.yml "${start_dir}/${v}.external-api-merged-bundled.yml"
done
