#!/usr/bin/env bash

set -e

start_dir=$(pwd)
spec_dir=$(mktemp --directory --suffix .spec)

cp --recursive common/ "${spec_dir}"

cd cmd/gather_openapi_specs
go run . --output "${spec_dir}" \
	--project "mainapi:${MAINAPI_OPENAPI_BRANCH}" \
	--external accounts \
	--external customers \
	--external disclosures \
	--external kyc \
	--external parties \
	--external partygroups \
	--external rdc \
	--external reconciliations \
	--external transactions \
	--project "webhook:${WEBHOOK_OPENAPI_BRANCH}" \
	--external webhooks \
	--project "cards:${CARDS_OPENAPI_BRANCH:-main}" \
	--external cards

cd "${spec_dir}"

openapi-merge-cli --config merge-internal-apis.json
openapi-merge-cli --config merge-external-apis.json

for spec in **/api.yml *-api-merged-bundled.yml; do
  swagger-cli validate "$spec"
done

cp ./*-api-merged-bundled.yml "${start_dir}"
