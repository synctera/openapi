#!/usr/bin/env bash

set -e

start_dir=$(pwd)
spec_dir=$(mktemp --directory --suffix .spec)

cp --recursive common/ "${spec_dir}"

cd "${start_dir}/cmd/gather_openapi_specs"
go run . --output "${spec_dir}" \
	--project "mainapi:${MAINAPI_OPENAPI_BRANCH}" \
	--external accounts \
	--external accounttemplates \
	--external accountproducts \
	--external customers \
	--external persons \
	--external businesses \
	--external relationships \
	--external disclosures \
	--external disclosures_legacy \
	--external verifications \
	--external externalaccounts \
	--external internalaccounts \
	--external kyc \
	--external reconciliations \
	--external watchlist \
	--project "webhook:${WEBHOOK_OPENAPI_BRANCH}" \
	--external webhooks \
	--project "cards:${CARDS_OPENAPI_BRANCH}" \
	--external cards \
	--external transaction_simulations \
	--external webhook_simulations \
	--project "waitlist:${WAITLIST_OPENAPI_BRANCH}" \
	--external waitlist \
	--project "trisk:${TRISK_OPENAPI_BRANCH}" \
	--project "achilles:${ACHILLES_OPENAPI_BRANCH}" \
	--external ach \
	--project "payola:${PAYOLA_OPENAPI_BRANCH}" \
	--external transactions \
	--project "checkmate:${CHECKMATE_OPENAPI_BRANCH}" \
	--external rdc

cd "${spec_dir}"

openapi-merge-cli --config merge-internal-apis.json
openapi-merge-cli --config merge-external-apis.json

cd "${start_dir}/cmd/externalfilter"
go run . -v "${spec_dir}/external-api-merged-bundled.yml"

cd "${spec_dir}"

# override each spec with header.yml to ensure they all match openapi version, our version and our servers
for spec in *-api-bundled.yml; do
  for field in openapi info servers; do
    yq eval-all "select(fileIndex==0).${field} = select(fileIndex==1).${field} | select(fileIndex==0)" "${spec}" "${start_dir}/header.yml" > ".tmp.${spec}"
    mv ".tmp.${spec}" "${spec}"
  done
done

for spec in **/api.yml *-api-merged-bundled.yml; do
  swagger-cli validate "$spec"
  openapi lint "$spec"
done

cp ./*-api-merged-bundled.yml "${start_dir}"
